@model IEnumerable<ENI_Projet_Sport.ViewModels.RaceViewModel>

@{
    ViewBag.Title = "Index";
}

<h2>Index</h2>

<p>
    @Html.ActionLink("Create New", "Create")
</p>
<table class="table">
    <tr>
        <th>
            @Html.DisplayNameFor(model => model.Name)
        </th>
        <th>
            @Html.DisplayNameFor(model => model.PlacesNumber)
        </th>
        <th>
            @Html.DisplayNameFor(model => model.City)
        </th>
        <th>
            @Html.DisplayNameFor(model => model.ZipCode)
        </th>
        <th>
            @Html.DisplayNameFor(model => model.Price)
        </th>
        <th>
            @Html.DisplayNameFor(model => model.Description)
        </th>
        <th></th>

        <th></th>
        <th></th>
        <th></th>
    </tr>

@foreach (var item in Model) {
    <tr>
        <td>
            @Html.DisplayFor(modelItem => item.Name)
        </td>
        <td>
            @Html.DisplayFor(modelItem => item.PlacesNumber)
        </td>
        <td>
            @Html.DisplayFor(modelItem => item.City)
        </td>
        <td>
            @Html.DisplayFor(modelItem => item.ZipCode)
        </td>
        <td>
            @Html.DisplayFor(modelItem => item.Price)
        </td>
        <td>
            @Html.DisplayFor(modelItem => item.Description)
        </td>
        <td>
            @Html.ActionLink("Details", "Details", new { id = item.Id })
        </td>
            @using Microsoft.AspNet.Identity
            @if (Request.IsAuthenticated)
            {
                <td>
                    <a data-id="@item.Id" class="register_link">Register</a>
                </td>
                <td>
                    @Html.ActionLink("Edit", "Edit", new { id = item.Id })
                </td>
                <td>
                    @Html.ActionLink("Delete", "Delete", new { id = item.Id })
                </td>
            }
    </tr>
}

</table>
<script>
    $('.register_link').unbind('click').on('click', register);

    $('.unsubscribe_link').unbind('click').on('click', unsubscribe);

    function register(evt) {
        var $that = $(evt.currentTarget);
        var id = $($that).data('id');
        $.ajax({
            type: "POST",
            url: "/Inscription/Create/" + id,
            data: id,
            dataType: "application/json",
            complete: function (data) {
                var obj = JSON.parse(data.responseText);
                if (data.status == 200 && obj == 200) {
                    var html = '<a data-id="'+id+'" class="unsubscribe_link">Unsubscribe</a>';
                    $($that).parent().html(html);
                    $('.unsubscribe_link').unbind('click').on('click', unsubscribe);
                    $.alert({
                        title: 'Inscription effectuée!',
                        content: 'Vous êtes inscrit à cette course!',
                    });
                }
                else {
                    $.alert({
                        title: 'Erreur!',
                        content: 'Une erreur est survenue!',
                    });
                }
            }
        });
    }
    function unsubscribe(evt) {
        $.confirm({
            title: 'Attention!',
            content: 'Souhaitez-vous vraiment vous désinscrire de cette course ?',
            buttons: {
                Oui: function () {
                    var $that = $(evt.currentTarget);
                    var id = $($that).data('id');
                    $.ajax({
                        type: "POST",
                        url: "/Inscription/Delete/" + id,
                        data: id,
                        dataType: "application/json",
                        complete: function (data) {
                            var obj = JSON.parse(data.responseText);
                            if (data.status == 200 && obj == 200) {
                                var html = '<a data-id="' + id + '" class="register_link">Register</a>';
                                $($that).parent().html(html);
                                $('.register_link').unbind('click').on('click', register);
                            }
                            else {
                                $.alert({
                                    title: 'Erreur!',
                                    content: 'Une erreur est survenue!',
                                });
                            }
                        }
                    });
                },
                Non: function () {

                }
            }
        });

        /*var $that = $(evt.currentTarget);
        var id = $($that).data('id');
        $.ajax({
            type: "POST",
            url: "/Inscription/Delete/" + id,
            data: id,
            dataType: "application/json",
            complete: function (data) {
                var obj = JSON.parse(data.responseText);
                if (data.status == 200 && obj == 200) {
                    var html = '<a data-id="'+id+'" class="register_link">Register</a>';
                    $($that).parent().html(html);
                    $('.register_link').unbind('click').on('click', register);
                }
                else {
                    $.alert({
                        title: 'Erreur!',
                        content: 'Une erreur est survenue!',
                    });
                }
            }
        });*/
    }
</script>
